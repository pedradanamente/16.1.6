USE BD2
GO

CREATE TABLE ALUNO(
ID INT IDENTITY(1,1) PRIMARY KEY,
NOME VARCHAR(30)
)

CREATE TABLE LIVRO(
ID INT IDENTITY(1,1) PRIMARY KEY,
TITULO VARCHAR(100)
)

CREATE TABLE RETIRADA(
ID INT IDENTITY(1,1) PRIMARY KEY,
ID_ALUNO INT,
ID_LIVRO INT,
DATA_RETIRADA DATETIME,
PREVISAO_DEVOLUCAO DATETIME
)

CREATE TABLE DEVOLUCAO(
ID_RETIRADA INT IDENTITY(1,1) PRIMARY KEY,
DATA_DEVOLUCAO DATETIME
)

INSERT INTO ALUNO(NOME) VALUES ('Hiago')
INSERT INTO LIVRO(TITULO) VALUES ('Sistemas de Informação')

INSERT INTO ALUNO(NOME) VALUES ('Mariana')
INSERT INTO LIVRO(TITULO) VALUES ('Biologia e Cidadania')

INSERT INTO ALUNO(NOME) VALUES ('Paulo')
INSERT INTO LIVRO(TITULO) VALUES ('Arquitetura moderna')


--QUESTÃO 1

USE BD2
GO

CREATE PROCEDURE SP_REGISTRO
@ID_ALUNO INT,
@ID_LIVRO INT,
@DATA_RETIRADA DATETIME
AS
	IF @ID_ALUNO <> '' AND @ID_LIVRO <> ''
	BEGIN
	DECLARE @ID_ALU INT, @ID_LIV INT
	SELECT @ID_ALU = ALUNO.ID FROM ALUNO WHERE ALUNO.ID = @ID_ALUNO
	SELECT @ID_LIV = LIVRO.ID FROM LIVRO WHERE LIVRO.ID = @ID_LIVRO
	
	
	INSERT INTO RETIRADA(ID_ALUNO, ID_LIVRO, DATA_RETIRADA) VALUES (@ID_ALUNO, @ID_LIVRO, @DATA_RETIRADA)
	END
	ELSE
		PRINT 'FALTA CAMPOS'
		
EXEC SP_REGISTRO 1,2, '10/12/2012'


--QUESTÃO 2

USE BD2
GO

CREATE PROCEDURE SP_DADOS
@ID_LIVRO INT
AS
	BEGIN
	DECLARE @NOME_A VARCHAR, @ID_L VARCHAR, @NRO_AL INT, @SITUACAO VARCHAR
	
	SELECT @ID_L = LIVRO.ID FROM LIVRO WHERE LIVRO.ID = @ID_LIVRO

	IF(EXISTS(SELECT @ID_L FROM RETIRADA WHERE RETIRADA.ID_LIVRO = @ID_LIVRO))
	SET @SITUACAO = 'ALUGADO'
	ELSE
	SET @SITUACAO = 'DEVOLVIDO'
	END
	
	PRINT (@NRO_AL, @NOME_L, @NRO_AL, @SITUACAO)




--QUESTÃO 3

USE BD2

GO

if OBJECT_ID('tg_RETIRADA') is not null
	drop trigger tg_RETIRADA
go

CREATE TRIGGER TG_RETIRADA ON RETIRADA AFTER UPDATE
AS
	DECLARE @ID INT, @DATA_RETIRADA DATETIME, @PREVISAO_DEVOLUCAO  DATETIME
	
BEGIN

	SELECT @ID = ID, @DATA_RETIRADA = DATA_RETIRADA, @PREVISAO_DEVOLUCAO = DATEADD (DAY,7,@DATA_RETIRADA) FROM INSERTED;
	
	UPDATE RETIRADA SET PREVISAO_DEVOLUCAO = @PREVISAO_DEVOLUCAO WHERE ID = @ID
END




